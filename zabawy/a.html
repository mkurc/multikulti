<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <title></title>
    <style>
span:hover {
        background-color: yellow;
} 
span::selection {
        color: red;
            cursor: move;
}

span::-moz-selection {
        background:yellow;
            cursor: move;
}
    </style>
<script src="js/rangy/rangy-highlighter.js"></script>
<script src="jsmol/JSmol.min.js" type="text/javascript" charset="utf-8"></script>
<script>
var jmol_selected = [];
var jmol_selected2 = [];
var jmol="jmol";
var jme = "jme";

// 1/21/2013 10:54:15 PM -- adds image handling
var jmolApplet0; // set up in HTML table, below
// logic is set by indicating order of USE -- default is HTML5 for this test page, though
var use = "HTML5" // JAVA HTML5 WEBGL IMAGE  are all options
var s = document.location.search;

// Developers: The debugCode flag is checked in j2s/core/core.z.js, 
// and, if TRUE, skips loading the core methods, forcing those
// to be read from their individual directories. Set this
// true if you want to do some code debugging by inserting
// System.out.println, document.title, or alert commands
// anywhere in the Java or Jmol code.

Jmol.debugCode = (s.indexOf("debugcode") >= 0);
jmol_isReady = function(applet) {
    var s_seq =  Jmol.evaluateVar(jmolApplet0, "{atomName=CA}.identify");
    var seq = Jmol.evaluateVar(jmolApplet0, "{atomName=CA}.sequence");
    var out = [];
    var numbersout = [];
        console.dir(s_seq);
    var prevchain='FNORD';
    for (var i=0;i<seq.length;i++) {
        var resid = s_seq[i].match(/](.*):/)[1];
        var chain = s_seq[i].match(/:(.*).CA/)[1];
        //out[i] = "<span name='"+resid+"' id='seq"+resid+"' data-resid='"+resid+"'>" + seq[i] + "</span>";
        if (resid%10==0) {
            if (chain!=prevchain) {
                prevchain=chain;
                out[i] = "</div><div data-chain='"+chain+"' id='sequenceSpan'"+chain+"'><br><strong>"+chain+"</strong>: <span name='"+resid+"' data-chain='"+chain+"' id='seq"+resid+""+chain+"' data-resid='"+resid+"' style='text-decoration: underline'>" + seq[i] + "</span>";
            } else{
                out[i] = "<span name='"+resid+"' data-chain='"+chain+"' id='seq"+resid+""+chain+"' data-resid='"+resid+"' style='text-decoration: underline'>" + seq[i] + "</span>";
            }

        }
        else{
            if (chain!=prevchain) {
                prevchain=chain;
                out[i] = "</div><div data-chain='"+chain+"' id='sequenceSpan'"+chain+"'><br><strong>"+chain+"</strong>: <span name='"+resid+"' id='seq"+resid+""+chain+"' data-chain='"+chain+"' data-resid='"+resid+"'>" + seq[i] + "</span>";
            } else{
                out[i] = "<span name='"+resid+"' id='seq"+resid+""+chain+"' data-chain='"+chain+"' data-resid='"+resid+"'>" + seq[i] + "</span>";
            }
        }
    }
    $("#sequenceSpan").html(out.join(''));

    $('p span').bind('mouseenter', function() {
        var v = $(this).data("resid");
        var chain = $(this).data("chain");
        //alert(v);
        $("#wybrane").html(v+":"+chain);//html() = v;
        Jmol.script(jmolApplet0,"restrict protein; halos off;select "+v+":"+chain+";  halos on");
        });

    $("[id^='sequenceSpan']").mouseup(function () { 
            highlightSelectedText();
            });

//	Jmol._getElement(applet, "appletdiv").style.border="none";
}	

var JmolInfo = {
	width: 400,
	height: 400,
	debug: true,
	color: "snow",
	addSelectionOptions: true,
	serverURL: "http://www2.chemistry.msu.edu/faculty/reusch/VirtTxtJml/htmlJ/jsmol/jsmol.php",
	use: "HTML5",
	readyFunction: jmol_isReady,
	script: "set platformSpeed 1;background white;load input.pdb.gz;restrict protein; trace only;color deepskyblue;color halos [255,0,0]",
	jarPath: ".",
	j2sPath: "./jsmol/j2s",
	isSigned: false,
	defaultModel: "",
        console: "true", 
}

var JMEInfo = {  
	use: "HTML5"
 //,divId: "jmediv"
	//,jarPath: "jme",
	//,jarFile: "JME.jar"
  //optional parameters
  //,"options" : "query,nohydrogens"
  //,"jme" : startingStructure 
}
</script>
</head>

<body>

<strong>Receptor:</strong>
<p style="font-family:monospace" id="sequenceSpan"></p>
<p style="font-family:monospace" id="sequenceSpan2"></p>
<p style="font-family:monospace" id="wybrane"></p>

<a href="#" id="sele">dodaj wiÄ™zy</a>
<br>zakres wybranych:
<table border=2>
<div id="selected">
</div>
</table>

<script>
jmol = Jmol.getApplet("jmolApplet0", JmolInfo);
jme = Jmol.getJMEApplet(jme , JMEInfo, jmol);
var lastPrompt=0;
</script>
</body>
<script src="jquery.js"></script>
<script src="js/rangy/rangy-core.js"></script>

<script type="text/javascript" charset="utf-8">
function getRangesAndChain(selection) {
        var endRes0 = selection.endContainer.parentNode.dataset['resid'];
        var endRes1 = selection.startContainer.parentNode.dataset['resid'];
        var chain = selection.startContainer.parentNode.parentNode.dataset['chain'];
        // tutaj mozna iteracje po tym zakresie i zmienic styl sekwencji
        var seqFrom = Math.min(endRes0, endRes1);
        var seqTo = Math.max(endRes0, endRes1);
        return [chain,seqFrom, seqTo];
}
function colorSeq(chain, seqFrom, seqTo) {
    //var twojastara = $("#sequenceSpan"+chain+" > span");
    //console.log(twojastara);
    $("sequenceSpan"+chain+" > span").filter(function() {
                    var rid = parseInt($(this).data("resid"));
                    return rid >= seqFrom && rid <= seqTo;
                    }).css({'background-color':'red'});
}
function uncolorSeq(chain, seqFrom, seqTo) {
    var twojastara = $("#sequenceSpan"+chain+" > span");
    twojastara.filter(function() {
                    var rid = parseInt($(this).data("resid"));
                    return rid >= seqFrom && rid <= seqTo;
                    }).css({'color':''});
}
function highlightOnStructure() {
    Jmol.script(jmolApplet0,"select "+jmol_selected2.join()+"; color blue");
    if (window.getSelection) {  // all browsers, except IE before version 9
            var currSelection = window.getSelection ();

            for (var i = 0; i < currSelection.rangeCount; i++) {
                var s = getRangesAndChain(currSelection.getRangeAt(i));
                jmol_selected2.push(s[1]+"-"+s[2]+":"+s[0]);
            }

            Jmol.script(jmolApplet0,"select "+jmol_selected2.join()+"; color red");
            currSelection.removeAllRanges ();
    }
}
function highlightSelectedText() {
    if (window.getSelection) {  // all browsers, except IE before version 9
            var currSelection = window.getSelection ();
            var selected = [];
            //var jmol_selected = [];

            for (var i = 0; i < currSelection.rangeCount; i++) {
                var s = getRangesAndChain(currSelection.getRangeAt(i));
                colorSeq( s[0], s[1], s[2]);
                jmol_selected.push(s[1]+"-"+s[2]+":"+s[0]);
                selected.push(s[1]+":"+s[0]+" - "+s[2]+":"+s[0]);
            }
            currSelection.removeAllRanges ();
            return selected;
    }
}
    $("#sele").click(function () { // dodaj zaznaczenie do listy zaznaczen
            var sss = highlightSelectedText();
            var prev = $("#selected").html();
            $("#selected").html(prev+"<tr><td>"+sss.join(", ")+"</td></tr>");//html() = v;
            Jmol.script(jmolApplet0,"select "+jmol_selected.join()+"; color green");
            /*
        var s = window.getSelection();
        var selRange = s.getRangeAt(0);
        var endRes0 = selRange.endContainer.parentNode.dataset['resid'];
        var endRes1 = selRange.startContainer.parentNode.dataset['resid'];
        var chain = selRange.startContainer.parentNode.dataset['chain'];
        // tutaj mozna iteracje po tym zakresie i zmienic styl sekwencji
        var seqFrom = Math.min(endRes0, endRes1);
        var seqTo = Math.max(endRes0, endRes1);
        for (var i=seqFrom;i<=seqTo;i++) {
            document.getElementById("seq"+i+""+chain).style.color = "orange"; 
        }
        var prev = $("#selected").html();
        v = prev + "<tr><td>" + s[0] + "</td><td>" + s[1] + " - " + s[2] + "</td></tr>";
        $("#selected").html(v);//html() = v;
*/



        });
/*
var s2 = document.getElementById("sequenceSpanA");


s2.onmouseup = function() { // rob cos na zaznaczonym, po zaznaczeniu (np zaznacz w jsmolu)
        var s = window.getSelection();
        
        var selRange = s.getRangeAt(0);
        var endRes0 = selRange.endContainer.parentNode.dataset['resid'];
        var endRes1 = selRange.startContainer.parentNode.dataset['resid'];
        var seqFrom = Math.min(endRes0, endRes1);
        var seqTo = Math.max(endRes0, endRes1);
        var chain = selRange.endContainer.parentNode.dataset['chain'];

        if (jmol_selected.length>0)
            Jmol.script(jmolApplet0,"select "+jmol_selected.join()+"; color green");
//	Jmol.script(jmolApplet0,"select protein; color deepskyblue");
        Jmol.script(jmolApplet0,"select "+seqFrom+"-"+seqTo+":"+chain+"; color [xfbb450]");
};
*/
</script>

</html>
