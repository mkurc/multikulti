{% extends "index.html" %}

        {% block indexuniq %}
        {% endblock %}
    {% block header %}
    <title>CABSdock: {{sys['project_name']}}</title>

    {% if status_type=='done' %}
        <script src="{{url_for('static', filename='js/jsmol/JSmol.min.js')}}" type="text/javascript" charset="utf-8"></script>
        <script>
        var jmol="jmol";
        var jme = "jme";
        var jmolApplet0; // set up in HTML table, below
        var use = "HTML5" // JAVA HTML5 WEBGL IMAGE  are all options

        jmol_isReady = function(applet) {}
        var JmolInfo = {
            width: '100%',
            height: '100%',
            debug: false,
            color: "white",
            addSelectionOptions: false,
            serverURL: "http://biocomp.chem.uw.edu.pl/jsmol.php",
            use: "HTML5",
            readyFunction: jmol_isReady,
           // script: "set platformSpeed 8;background white;set frank off;set hoverDelay 0.001;set bondTolerance = 5.0;load {{url_for('sendfile', filetype='models', filename=results['models'][0], jobid=jid)}};restrict protein; color chain;trace only",
            script: "set platformSpeed 8;background white;set frank off;set hoverDelay 0.001;load {{url_for('sendfile', filetype='models', filename=results['models'][0], jobid=jid)}};restrict protein; color chain;cartoons on",
            j2sPath: "{{url_for('static', filename='js/jsmol/j2s')}}",
            isSigned: "true",
            defaultModel: "",
            console: "false",
}
var JMEInfo = {  
	use: "HTML5"
}
        </script>
    {% endif %}


    {% endblock %}

{% block body %}
<div class="container">

<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">
    <li {% if status_type!='done'%}class="active"{%endif%}><a href="#summary" role="tab" data-toggle="tab"><i class="fa fa-info"></i> Project information</a></li>
{% if status_type=='done' %}
  <li class="active"><a href="#models" role="tab" data-toggle="tab"><i class="fa fa-flask"></i> Docking prediction results</a></li>
  <li><a href="#clustering" role="tab" data-toggle="tab"><i class="fa fa-bar-chart"></i> Clustering details</a></li>
{% endif %}
</ul>

<!-- Tab panes -->
<div class="tab-content">
  <div class="tab-pane {% if status_type!='done'%}active{%endif%}" id="summary">
              
            <div class="row">
                <div class="col-md-6">
            <h3>
                Project name: {{sys['project_name']}}
            </h3>

        </div>
        <div class="col-md-6">
            <h4>Status:                    {{status|safe}}</h4>
            <h6>submitted: {{sys['status_date']}}, status changed: {{sys['status_change']}}</h6>
            </div>

        </div>

            <hr>

      <table class="table table-striped">
        <tr>
            <td><strong>
Receptor sequence(s)
                </strong>
            </td>
            <td>
                <span class='sequence'>{{sys['receptor_sequence']}}</span>
            </td>
        </tr>


        <tr>
            <td><strong>
Ligand sequence
                </strong>
            </td>
            <td>
                <span class='sequence'>{{sys['ligand_sequence']}}</span>
            </td>
        </tr>
        <tr>
            <td><strong>
                    Ligand secondary structure 
                </strong>
                    {% if sys['ss_psipred']==1 %}
                    <span class="label label-primary pull-right">by <span class='capi'>psipred</span></span>
                    {% endif %} 
            </td>
            <td>
                    {% if sys['ligand_ss']|length != sys['ligand_sequence']|length %}
                    <small><i>waiting for PSIPRED prediction</i></small>
                    {% else %}
                <span class='sequence'>{{sys['ligand_ss']}}</span>
                    {% endif %}
            </td>
        </tr>
      <tr><td>
      <h5>Restraints <small>restrained chain fragments and force scaling factor</h5>
      </td>
      <td>
          
      <table class="table table-bordered table-stripped">
          {% set break=5 %}
          {% set iter=0 %}
        <tr>
          {% for row in constr %}
          <td><small>{{row['constraint_definition']}}</small> <span class="badge">{{row['force']}}</span></td>
            {% set iter = iter + 1 %}
            {% if iter==break %}
                </tr><tr>
            {% set iter=0 %}
            {%endif%}

            
          {% endfor %}
      </table>
  </td>
  </tr>
  <tr><td><h5>Restraints global scaling factor</h5></td><td> {{sys['constraints_scaling_factor']}}</td></tr>

      </table>


  </div> <!-- end tab summary -->
  <div class="tab-pane {% if status_type=='done'%}active{%endif%}" id="models">
      <div class="row">
          <div class="behind col-md-8">
            <div id="ooo" style="height:500px;border:0px solid;border-color:#eee;margin-bottom:15px">
                <script>
                Jmol._alertNoBinary = false;
                jmol = Jmol.getApplet("jmolApplet0", JmolInfo);
                jme = Jmol.getJMEApplet(jme , JMEInfo, jmol);
                var lastPrompt=0;
                </script>
            </div>
          </div>

          <div class="col-md-4">
              <div class="panel panel-primary">
                  <div class="panel-heading"><i class="fa fa-flask"></i> Representative conformations</div>
                  <div class="panel-body">
              {% set fir=True %}
      {% for e in results['models'] %}
        <div class="row">
            {% if fir %}
            <div class="col-md-5"><h5><span name="V{{e}}"><i class="fa fa-arrow-circle-left"></i></span> {{e.split(".")[0]}}</h5></div>
            {% set fir=False %}
            {% else %}
            <div class="col-md-5"><h5><span name="V{{e}}"></span> {{e.split(".")[0]}}</h5></div>
            {% endif %}
            <div class="col-md-3"><button onClick="loadStructure(this)" data-model="{{e}}" class="btn btn-xs btn-success"><i class='fa fa-eye'></i> View</button></div>
            <div class="col-md-4"><a class="btn btn-xs btn-primary" target=_blank href="{{url_for('sendfile', filetype='models', filename=e, jobid=jid)}}"><i class='fa fa-download'></i> Download</a></div>
        </div>

      {% endfor %}
                  </div></div>
      <hr>
      <a class='btn btn-block btn-lg btn-primary' href="{{url_for('tar', jobid=jid)}}" target=_blank><i class='fa fa-download'></i> Download all files</a>
          </div>
      </div>
  </div> <!-- end tab models -->
  <div class="tab-pane" id="clustering">
      <div class="row">
        <div class="col-md-8">
            tabelki eremesy mozeo
        </div>

        <div class="col-md-4">      
            <div class="panel panel-primary">
                <div class="panel-heading"><i class="fa fa-bar-chart"></i> Clusters</div>
                <div class="panel-body">
            {% for e in results['clusters'] %}
                <div class="row">
                    <div class="col-md-8"><h5><span name="R{{e}}"></span> {{e.split(".")[0]}}</h5></div>
                    <div class="col-md-4"><a class="btn btn-xs btn-primary" href="{{url_for('sendfile', filetype='clusters', filename=e, jobid=jid)}}"><i class='fa fa-download'></i> Download</a></div>
                </div>
            {% endfor %}
                </div>
            </div>
        </div>
  </div>

  </div> <!-- end tab clustering -->
  <div class="tab-pane" id="replicas">
  </div> <!-- end tab costam -->
</div>
{% if status_type=='done' or status_type=='error' %}
<br>&nbsp;
<div class="alert alert-warning alert-dismissible" role="alert">
  <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
  <i class="fa fa-recycle"></i> <strong>Note</strong> This page will be automatically deleted on {{sys['del']}}.
</div>
{% endif %}

</div>
{% endblock %}
{% block below_js %}
<script>
function loadStructure(o) {
    var oldidx = o.dataset.model;
    
    var template = "{{url_for('sendfile', filetype='models', filename='TOREPLACE', jobid=jid)}}";
    var curr_model = template.replace("TOREPLACE", oldidx);
            //script: "set platformSpeed 8;background white;load {{url_for('sendfile', filetype='models', filename=results['models'][0], jobid=jid)}};restrict protein; trace only;color chain",
    Jmol.script(jmolApplet0,"load "+curr_model+"; restrict protein; color chain;cartoons on");
    $("span[name^=V]").html("");
    $("span[name^=V"+oldidx.split(".")[0]+"]").html("<i class='fa fa-arrow-circle-left'></i>");
}
</script>
{% endblock %}
